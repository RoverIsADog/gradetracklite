# Summary of changes on the massive commit on 2023-03-31
I included some further readings if you want to have a rougher idea of what is happening. You can delete this file once you're caught up.

# Rename API Field Names
In general, lowerCamelCase everything. Rename a few variables. Look at the diff of the first commit in branch `api-reconciliation` for more details.

The new names are synchronised with the frontend so touching them in any way will break things. I believe I also updated the field names in the code so that API request/response field names are equal to the variables in the code.

I didn't touch the DB's naming though.

https://google.github.io/styleguide/jsoncstyleguide.xml?showone=Property_Name_Format#Property_Name_Format

# Change API Paths
To be able to serve static webpages (the frontend) using Express, I moved all API calls to within `host/api/v1/`. Furthermore, all their paths have changed. They are now grouped into functionality. Below is a copy paste of the readme.

## General Syntax
`hostname/api/v1/dataTypeOrFunctionality/action`

Example: `localhost:8000/api/v1/courses/list`

| URL Element | Description |
| -- | -- |
| `hostname` | Always there. Address of the GradeTrackLite host |
| `api/v1` | Always there. To distinguish API versions and from static files served from `/` |
| `dataTypeOrFunctionality` | Denotes either a type of data (`semesters`/`courses`/`categories`/`grades`) or a functionality such as authentication or account management (`auth`/`account`) |
| `action` | Do some action with regards to the resource or functionality. <br>For data, we generally have: <br> <ul><li>`list`: Given a parent's ID, get a list of all instances of that resource belonging to the parent.</li><li>`add`: Given a parent's ID, add an instance of the resource to the parent</li><li>`get`: Get a specific instance of the resource (and all "children"). Currently only for courses (and that won't change).</li><li>`edit`: Modifies a specified instance of the resource.</li><li>`delete`: Deletes a specified instance of the resource</li></ul>For functionalities, we have stuff like `login`/`resister`/... |

A major change from this is that `/add-category` was moved into its own file `categories.js` instead of being bundled with `grades.js`. It's now known as `/categories/add`

https://www.akana.com/blog/api-versioning

# Added entries for unimplemented APIs
Thought about any and all requests we may need and added them to the README. There's a lot of them but most should be very easy to implement since they share most of the syntax and response.

* Modifying sem/course/cat/grade
  * This one should be almost the same as adding.
* Deleting sem/course/cat/grade
  * Super easy (literally 1 sql statement). **Just use cascading delete** (delete a semester -> its courses are missing their foreign keys so they autodelete -> their categories are missing their foreign keys so they autodelete -> their grades are missing their foreign keys so they autodelete). Gotta love sql sometimes.
* Accound management
  * Changing info / password may by annoying
  * Downloading data may be annoying. If we're lazy we can have 1 line of JS code and just join everything together in **one big SQL statement** and return a massive csv.
  * Deleting is super easy again just use cascading delete

**I added API routes for all the missing API entries, but accessing them just returns either trash or a 501: Unimplemented.**

```js
// Example of unimplemented API
router.post("/edit", (req, res) => {
  //TODO
  res.sendStatus(501);
});
```

If you go to `/api/v1/account/download` with the proper auth token, it will prompt for saving a file (which was built from an object on the server).
https://stackoverflow.com/questions/21950049/create-a-text-file-in-node-js-from-a-string-and-stream-it-in-response

# Routing
To allow serving the website directly on Express instead of having a separate webserver (remember, we allow self-hosting), the path `host/` gets the website (it will fetch it from the `public` folder). All API urls were changed to be nested within `host/api/v1/`. 

Replaced the old import system of splitting into different files with the "intended" way with Express Routers. Each file is now home to a route (/semesters/courses/...), and that file's managing router gets given a JWT validation middleware if the route is restricted.

https://expressjs.com/en/guide/routing.html#express-router

https://expressjs.com/en/starter/static-files.html

```js
// Routes
const authRouter = require("./routes/authentication");
app.use("/api/v1/auth", authRouter); // No token required

const semesterRouter = require("./routes/semesters");
app.use("/api/v1/semesters", jwtMiddleware, jwtErrorHandler, semesterRouter);
```

# JWT Authentication Middleware
Use the official JWT middleware to reject invalid tokens before they even arrive at our code instead of spamming the same verification code for every request. As a bonus, if authentication is successful, the middleware will **decode** the token and place the decoded content into `req.auth`, which can be used by our code since I put the middleware before in the chain.

See the `/semesters/list` request for an example of request where the JWT MW ran before it, so `req.auth` is accessible and printed.

**THIS MEANS BOILERPLATE COPY-PASTED CODE TO CHECK THE TOKEN ON EACH REQUEST ARE NOW REDUNDANT AND CAN BE REVOVED** (JWT middleware fails the request before it has the chance of reaching old boilerplate JWT checking code). I tested a bunch and everything seems fine, but you can test some more before removing.

```js
const { expressjwt } = require("express-jwt");
const jwtMiddleware = expressjwt({ secret: JWT_SECRET, algorithms: ["HS256"] });
const jwtErrorHandler = function (err, req, res, next) {
  if (err.name === 'UnauthorizedError') {
    res.status(401).send('invalid token');
  }
};
// These two MW are passed on to routes that are restricted
```

https://github.com/auth0/express-jwt#error-handling

There's a 2nd middleware `jwtErrorHandler` used so that we can return a generic error message instead of the stacktrace on failure (that exposes the server's folder structure)

# Serve the frontend from the public folder
You don't need to worry about this one too much. I already implemented everything needed for this to happen. That's what the code below does.
```js
// Serve static webpages from /
// THIS MUST REMAIN AT THE END OTHERWISE THE * WILL MATCH OTHER ROUTES!!!!
app.use(express.static(path.join(__dirname, "public")));
app.get("/*", function (req, res) {
  // This is to allow react path reloads (client navigation).
  res.sendFile(path.join(__dirname, "public", "index.html"));
});
```

https://expressjs.com/en/starter/static-files.html

https://create-react-app.dev/docs/deployment/#docsNav

# Use API requests to get the host's custom privacy policy and terms of use
Since we want hosts to supply their own legal documents, we put them inside of folder `static/privacy.md` and `static/terms.md`. The client can then use a request to access them. The requests are handled by `routes/static.js`. 

I already finished this part so you don't have to worry about it.

# Enforce Configs on Launch
A new folder `conf` was created with the goal of putting all configuration files inside instead of random things scattered all over the place. All relevant configurations are stored in file `conf/.env`. If it's missing or if it's missing content, then the server will simply not launch.

From now on, we should never acces `process.env.XXXX` outside of `server.js`. It was super unsafe before and it still is.

Sample `.env`
```yaml
# The following keys are relating to JWT secrets
JWT_SECRET = "subway"
JWT_EXPIRATION_TIME = 86400

# What port to run the server on
PORT = 8000

# The following keys are relating the whether to use HTTPS.
# SSL_PRIVATE_KEY and SSL_CERTIFICATE only required if using HTTPS (paths to key/cert).
HTTPS_ENABLED = false
SSL_PRIVATE_KEY = conf/key.pem
SSL_CERTIFICATE = conf/cert.pem
```

# Enable HTTPS (optional)
Since we want to allow self-hosting, there is now the option to enable HTTPS by changing a setting in `.env`. You WILL need to provide a key and its certificate though. If you want to try it out, go to `conf/` and:
```bash
cd server/conf/
# Generate a key
openssl genrsa -out key.pem
# Generate a certification request for that key
openssl req -new -key key.pem -out csr.pem
# Self-sign that key (or use Certbot but I don't own a server with port 80 open)
# Just trust that if someone wants to enable HTTPS, they know what they're doing. 
openssl x509 -req -days 9999 -in csr.pem -signkey key.pem -out cert.pem
```

If you self-sign, your browser will be mad, but it is what it is. If you enable https, you must access the frontend from `https://localhost:8000/`. Excluding https will fail.

https://adamtheautomator.com/https-nodejs/

https://dev.to/omergulen/step-by-step-node-express-ssl-certificate-run-https-server-from-scratch-in-5-steps-5b87

# Add development scripts to the server
Instead of manually doing `node server.js`, I added two scripts in `package.json` to make launching easier. When you're in the `/server` folder:

To launch (production)
```bash
npm run start
```
To launch (development) (The server uses nodemon to hot reload on any file changes so no need to stop and restart the server every time there's a change).

# Add build and launch scripts
Added scripts to quickly get the project running in the root folder.

## `build.sh`
* Builds the react app into raw HTML/CSS/JS, then copies the newly built artifacts into `server/public` (Recall, that's were we're serving the website from).
* Create `conf/.env` if it doesn't exist yet

## `start.sh`
* Runs the server (run `build.sh` first)

# Misc .gitignored files you probably want to create
## Inside `server/conf`

`conf/.env` (the old `.env` in folder `server` is no longer good)
```yaml
# The following keys are relating to JWT secrets
JWT_SECRET = "subway"
JWT_EXPIRATION_TIME = 86400

# What port to run the server on
PORT = 8000

# The following keys are relating the whether to use HTTPS.
# SSL_PRIVATE_KEY and SSL_CERTIFICATE only required if using HTTPS (paths to key/cert).
HTTPS_ENABLED = false
SSL_PRIVATE_KEY = conf/key.pem
SSL_CERTIFICATE = conf/cert.pem
```

The keys are not used anywhere, I just generated them quickly.

`conf/key.pem` (Some key I generated for using SSL)
```txt
-----BEGIN RSA PRIVATE KEY-----
MIIEpAIBAAKCAQEAsYFU134U072bmGVQm+pItMOYyOnthGMBLpuBGFH1qGAxprP6
750oxgCQIFhPw7juylPYh7o+phnbNTLvfGSw3EhQoDbQ/CHzplgFkBfRecu5q2KC
UNncyvPQqZk2/v0et5ZHXsjItZHaB9kZNuSwqDlxxdRLD0sKDbuhNpQ6+OahVT3U
5uVpSt18mYzmJpdHvU0Qjtnr9QUZtpa4ZBRWVYvGrTcIvKO6ku1EToTwkuiuFWdx
bcSgKv2acLOdY0GF0gCxom1t2IFObiYP0F2I7QVn7KC6Sjvbyw9Pgp58jMsQOePN
BWyb4DCCxrzV7i6ouaPKjf0+2rENFCb6EO8ZvwIDAQABAoIBAGnwcHx0aWW+QkEA
Js4HVAFew68VvoZGuIvij3e+YsltL/T4cgnUWGNkLqC/VEvR8eKbjB3lkEJ+KBBm
J/yr88pk9onIbY4tjUd4PUm0jXcNmfCpyHEMtfQC9ERkhyhEVbLoZAwz9WY4eFI6
xgu3DaA5OKgDfhDQjl2H4D281j16GIaL2eaFhuCzT+aZRV2U2ZNxdBOeXxQWljws
2ydE2y/SV0R9QPSRmAMnVvQ247OZ5Wp4lTP4Zm8Ag1rcmhF/69GcwMLZqo3VRw8Q
f6DF2yBuBmTaYSzNzITm7yDVa1YUC5X8hRPY5yVgZ6kphRRseEsRuIVItdlqfYTa
Jh3KVhECgYEA6/5ibf4dn1qtYdNelwfFU98WeB/6UeHumn6PFfO9hcbmTISTzRin
9qAShoDETaVtKR/e8FODnUZVQ3V7YFmmIF6ezS4sal7hQH7bG06mLYV+NmbnaNQp
H2J8GVMb2ecDfS8SbOKFGsx9B1Qs1w7NAZMnpNOXzy69w2JtSXqUrOMCgYEAwI2c
G/QvfcQw/aLyvKofM634V8MDPb+JdrtJ4xoxs6MYkeYBpCo3m9zDS+/ubPRiLwVw
AIeOvJqnaHXixKK1ATKpdzv2454RlzufhlIBvBkSkdvMXSfoIfSnctHZIe/9kpV6
m8I1g4Xf4GMLDXSEoz1M9fgsNnEOdNsoPbk1cnUCgYBnx1JZtGoqbaHZZy4tlIk+
PNiQst9NquFWp1kc+jbZ4YHdHGAyzSjv16zN4UpyKtE6SH2ticxTGV7db4h18naP
vYxwBmIZ1OeRiTepZojFc/Lw0YfqHYKH/rM8H8Qbqu9p2Y1svKB0DIDe/DFL0YJt
sty4KySTQ6bHiT0uFu3SqQKBgQCV768XtVUlwZfEaRZLAs25GEbBUAE+G9+WrNAk
H0mEcAO52Dh+9MDIhWctwm8OOF4b70f/oY7sHiEtnl4ub+QyQpjjV7YwF+3qrWrS
1Ri0t3FWUqkYAPMpPbEGH5HMc2wosG0AzIGPILfrqjP5DjoaQqmi/tSur+pp5B25
snaD4QKBgQCvLH/TWzrId5YOEJTNRScpwVkfbbcqMNubdmLP5Q9NP27m7bDf+2A5
ZaVn+XGgHn3Kl/4QaULeBQbGBO8A0PluI4Dk+Y0DqAtpHghf3JuiM+RdyABdFrRh
YRuU3Kd+wfMVx6ydoNFLuYOVYKeQywqsrbb9w4EsXHblpjF6QEDeXQ==
-----END RSA PRIVATE KEY-----
```

`conf/csr` (Certification request, probably not necessary)
```txt
-----BEGIN CERTIFICATE REQUEST-----
MIICvTCCAaUCAQAwYzELMAkGA1UEBhMCQ0ExDzANBgNVBAgMBlF1ZWJlYzERMA8G
A1UEBwwITW9udHJlYWwxGTAXBgNVBAoMEENPTVA1NTVUZWFtNyBMTEMxFTATBgNV
BAMMDENPTVA1NTVUZWFtNzCCASIwDQYJKoZIhvcNAQEBBQADggEPADCCAQoCggEB
ALGBVNd+FNO9m5hlUJvqSLTDmMjp7YRjAS6bgRhR9ahgMaaz+u+dKMYAkCBYT8O4
7spT2Ie6PqYZ2zUy73xksNxIUKA20Pwh86ZYBZAX0XnLuatiglDZ3Mrz0KmZNv79
HreWR17IyLWR2gfZGTbksKg5ccXUSw9LCg27oTaUOvjmoVU91OblaUrdfJmM5iaX
R71NEI7Z6/UFGbaWuGQUVlWLxq03CLyjupLtRE6E8JLorhVncW3EoCr9mnCznWNB
hdIAsaJtbdiBTm4mD9BdiO0FZ+yguko728sPT4KefIzLEDnjzQVsm+Awgsa81e4u
qLmjyo39PtqxDRQm+hDvGb8CAwEAAaAVMBMGCSqGSIb3DQEJBzEGDAQxMjM0MA0G
CSqGSIb3DQEBCwUAA4IBAQCCljsDomILYHjPY3OROOzOssy+uIefcTyxCm0V9E9Z
EEcF+VB2sYvN2jgvSX81s7Qcqtlg61PLUTZLRjyZIIuM5zrpUmw1dfNN1rrpwGN9
OxLQPTgAlkHL9cCAOBb2mmwosVZk5FYjFPrjSM4Mv049jiRgNmpZ7Zn14DcbDzoX
plSRgOoYV3sGTmoGQ6ZiKX+onIIrFJ1MPAPUezAdFsgnyvbUof8dMO6sYiqsRXs1
Y1KLtwK0MzeGJRqLX7JqKR3m3tj7DFeQelIuwv4jiu0SJMH82DrXpwOgni+ONFZi
V5gsBYPApvOgf5jyCGJs3mL5Tnag0fqdlezx1unHpVYm
-----END CERTIFICATE REQUEST-----
```

`conf/cert.pem` (Certification)
```txt
-----BEGIN CERTIFICATE-----
MIIDTzCCAjcCFChlMJ8BWTishKlnEI9dAWCAJKBVMA0GCSqGSIb3DQEBCwUAMGMx
CzAJBgNVBAYTAkNBMQ8wDQYDVQQIDAZRdWViZWMxETAPBgNVBAcMCE1vbnRyZWFs
MRkwFwYDVQQKDBBDT01QNTU1VGVhbTcgTExDMRUwEwYDVQQDDAxDT01QNTU1VGVh
bTcwIBcNMjMwNDAzMDE0MTExWhgPMjA1MDA4MTgwMTQxMTFaMGMxCzAJBgNVBAYT
AkNBMQ8wDQYDVQQIDAZRdWViZWMxETAPBgNVBAcMCE1vbnRyZWFsMRkwFwYDVQQK
DBBDT01QNTU1VGVhbTcgTExDMRUwEwYDVQQDDAxDT01QNTU1VGVhbTcwggEiMA0G
CSqGSIb3DQEBAQUAA4IBDwAwggEKAoIBAQCxgVTXfhTTvZuYZVCb6ki0w5jI6e2E
YwEum4EYUfWoYDGms/rvnSjGAJAgWE/DuO7KU9iHuj6mGds1Mu98ZLDcSFCgNtD8
IfOmWAWQF9F5y7mrYoJQ2dzK89CpmTb+/R63lkdeyMi1kdoH2Rk25LCoOXHF1EsP
SwoNu6E2lDr45qFVPdTm5WlK3XyZjOYml0e9TRCO2ev1BRm2lrhkFFZVi8atNwi8
o7qS7UROhPCS6K4VZ3FtxKAq/Zpws51jQYXSALGibW3YgU5uJg/QXYjtBWfsoLpK
O9vLD0+CnnyMyxA5480FbJvgMILGvNXuLqi5o8qN/T7asQ0UJvoQ7xm/AgMBAAEw
DQYJKoZIhvcNAQELBQADggEBAJlY7N4Ir/ZL8sn1kDJu+9mmxdFulmvafPoJ/mZi
gS6qQIFwDh6mW0/vx+zzalcGTtzqjTiQyGuV5EH5yKvGmjxu6/u7MZ4GmlOYl0OY
cMnHcayjXgHgB0/CmZ7Bqnnvh0JqdHZvAZtpgeyDEtfvEbfdx9Aa7TTteMieb+wV
ZTY2TWgoctOX0BlAwoellrhU0sZmOo9wvIzp47tINkh8AyoouypLdxIU5GeijcXu
P88V5JoRNADvYPpbXp7oX1KMmuD8YUtQi5hwlBG/z2OrGfL8Gcq1tmrdCylPzx8L
cynk5I0mMkurCZT0xRVuAsFQwaAZ/l72NRjOAA57xpcXSwg=
-----END CERTIFICATE-----
```

## Inside `server/static`

`static/privacy.md`
```md
# Privacy Policy
This is a sample privacy policy. You are free to change it.

## Praesent est est
Praesent pretium rutrum nunc, vitae feugiat sapien ultrices bibendum. Vestibulum ante ipsum primis in faucibus orci luctus et ultrices posuere cubilia curae; Curabitur auctor condimentum tortor, id tempus tellus fringilla sed. Curabitur malesuada velit et metus aliquet lobortis. Praesent magna sapien, euismod semper mi ut, molestie egestas enim. Praesent quis efficitur nisl. Praesent est est, aliquam ut metus id, tempor tempor ipsum.
```

`static/terms.md`
```md
# Terms of use
This is a sample terms of use. You are free to change it.

## Praesent est est
Praesent pretium rutrum nunc, vitae feugiat sapien ultrices bibendum. Vestibulum ante ipsum primis in faucibus orci luctus et ultrices posuere cubilia curae; Curabitur auctor condimentum tortor, id tempus tellus fringilla sed. Curabitur malesuada velit et metus aliquet lobortis. Praesent magna sapien, euismod semper mi ut, molestie egestas enim. Praesent quis efficitur nisl. Praesent est est, aliquam ut metus id, tempor tempor ipsum.
```